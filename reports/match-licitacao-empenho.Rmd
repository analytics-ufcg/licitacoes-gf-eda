---
title: "Licitações e empenhos"
output:
    html_document:
    df_print: paged
theme: sandstone
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(hrbrthemes)
theme_set(theme_ipsum_rc())

knitr::opts_chunk$set(tidy = FALSE,
                      fig.width = 6,
                      fig.height = 4,
                      echo = FALSE)

paleta = c("#404E4D",
           "#92DCE5",
           "#938BA1",
           "#2D3142",
           "#F4743B")
```


```{r}
lics = read_csv2("data/raw-portal/202101_Licitacoes/utf8-202101_Licita‡ֶo.csv")
empsrel = read_csv2("data/raw-portal/202101_Licitacoes/utf8-202101_EmpenhosRelacionados.csv")

lics20 = read_csv2("data/raw-portal/202001_Licitacoes/utf8-202001_Licita‡ֶo.csv")
empsrel20 = read_csv2("data/raw-portal/202001_Licitacoes/utf8-202001_EmpenhosRelacionados.csv")
    
licst = bind_rows(jan2021 = lics, 
                  jan2020 = lics20, 
                  .id = "ano")
empsrelt = bind_rows(jan2021 = empsrel, 
                     jan2020 = empsrel20, 
                     .id = "ano")

licst %>% count(ano)
empsrelt %>% count(ano)

licst %>% count(`Situação Licitação`, ano)
```

```{r}
les =  licst %>% left_join(empsrelt) %>% janitor::clean_names()

com_empenho = les %>%
    group_by(numero_licitacao, modalidade_compra, ano, situacao_licitacao) %>%
    summarise(tem_empenho = if_else(any(!is.na(codigo_empenho)), "Sim", "Não"),
              .groups = "drop") %>%
    count(modalidade_compra, tem_empenho, ano, situacao_licitacao)

com_empenho %>%
    filter(situacao_licitacao %in% c("Encerrado", 
                                     "Publicado", 
                                     "Evento de Resultado de Julgame")) %>%
    ggplot(aes(x = modalidade_compra, y = n, fill = tem_empenho)) +
    facet_grid(situacao_licitacao ~ ano) +
    geom_col() +
    scale_fill_manual(values = c("brown", "gray")) +
    coord_flip() + 
    labs(x = "", y = "Número de licitações", fill = "Tem empenho associado?")

ggsave("empenhos.png", height = 8, width = 9)
```


```{r read}
empenhos = read_csv(here::here("data/raw/despesa_empenho.csv.gz"))


```